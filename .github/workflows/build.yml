name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  SOLUTION_FILE_PATH: ./devops
  BUILD_CONFIGURATION: Debug
  SONAR_WRAPPER_URL: https://sonarcloud.io/static/cpp/build-wrapper-win-x86.zip
  SONAR_SCANNER_URL: https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.5.0.2216-windows.zip

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2
      with:
        vs-version: '[,16.8]'
    
    - name: Cache build wrapper & SonarScanner
      id: cache-sonar
      uses: actions/cache@v2
      with:
        path: |
          build-wrapper
          sonar-scanner
        key: ${{ runner.os }}-sonar-cache

    - name: Install SonarScanner
      if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
      run: |
        Invoke-WebRequest -Uri "${{ env.SONAR_WRAPPER_URL }}" -OutFile build-wrapper.zip
        Invoke-WebRequest -Uri "${{ env.SONAR_SCANNER_URL }}" -OutFile sonar-scanner.zip
        Expand-Archive build-wrapper.zip
        Expand-Archive sonar-scanner.zip

    - name: Build
      shell: pwsh
      run: |
        .\build-wrapper\build-wrapper-win-x86\build-wrapper-win-x86-64.exe --out-dir bw_output msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}

    - name: SonarScanner
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      shell: pwsh
      run: |
        ./sonar-scanner/sonar-scanner-4.5.0.2216-windows/bin/sonar-scanner.bat -Dsonar.cfamily.build-wrapper-output=./bw_output

      # SET PATH=%PATH%;%cd%\build\sonar-scanner\bin
      # ECHO PATH=%PATH%
      # ECHO DIR %cd%\build\bw_output\
      # DIR %cd%\build\bw_output\
      # ./sonar-scanner.bat -Dsonar.cfamily.build-wrapper-output=%cd%\build\bw_output

      # 1. community 글 참조해서 sonar wrapper와 sonar scanner 설치, 추가로 cache활용까지
      # 2. build wrapper와 msbuild를 함께 사용해서 build, msbuild path설정 필요.
      #    build-wrapper-win-x86-64 --out-dir build\bw_output msbuild
      # 3. sonar 빌드 결과물에 sonar scanner 적용

      # token설정이 필요하다.
